<html>
<head>
<LINK href="toggle.css" rel="stylesheet" type="text/css">
<style>
ul, li
{
	list-style-type: none;
}
.icon
{
	color: #ffa500;
	text-decoration: none;
	font-size: 22px;
}
div.pluginHolder
{
	position: relative;
	outline-style:solid;
	margin: 3px;
	background-color: #000000;
	width: 750px;
}
div.gripper
{
	border-color: #ffa500;
	border-top-style: none;
	border-right-style: solid;
	border-bottom-style: none;
	border-left-style: solid;
	position: absolute;
	top: 4px;
	bottom: 4px;
	left: 4px;
	border-width: 2px;
}
div.pluginHandle
{
	background-color: #000000;
	float: left;
	width: 20px;
	position: absolute;
	top: 0px;
	bottom: 0px;
	left: 0px;

}
div.pluginBar
{
	background-color: #000000;
	float: right;
	width: 20px;
	text-align: center;
}
div.plugin
{
	background-color: #000000;
	margin: 3px;
	float: left;
	width:700px;
	padding-left: 24px;
}
div.palette
{
	display:block;
}
div.rack
{
	display: block;
}
span.pluginName
{
	display: block;
}
span.pluginDescription
{
	display: block;
}
div.knobHolder
{
	background-color:#ffffff;
	outline-style:solid;
	float: left;
	margin:2px;
}
span.paramName
{
	display:block;
}
.sortable-dragging
{
	
}
.sortable-placeholder
{
	outline-style: dotted;
	border: 2px;
	background-color: #ffffff;
	border-color: #000000;
	height: 150px;
}
</style>
<script src="jquery-1.10.2.min.js"></script>
<script src="jquery.knob.js"></script>
<script src="jquery.sortable.min.js"></script>
<script>
JSON.stringify = JSON.stringify || function (obj) {
    var t = typeof (obj);
    if (t != "object" || obj === null) {
        // simple data type
        if (t == "string") obj = '"'+obj+'"';
        return String(obj);
    }
    else {
        // recurse array or object
        var n, v, json = [], arr = (obj && obj.constructor == Array);
        for (n in obj) {
            v = obj[n]; t = typeof(v);
            if (t == "string") v = '"'+v+'"';
            else if (t == "object" && v !== null) v = JSON.stringify(v);
            json.push((arr ? "" : '"' + n + '":') + String(v));
        }
        return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
    }
};

Array.prototype.insert = function (index, item) {
  this.splice(index, 0, item);
};
</script>
<script>


// holds JSON of all of the plugins
var _allPlugins;

// things to do at startup
$(document).ready(function() {
	
	// get all the available plugins supported
	getAllPlugins();
	console.log(_allPlugins.length + " plugins available.");
	
	// create the 'palette' by which we add plugins to the chain
	var html="";
	_allPlugins.forEach(function(plugin) {
		html+='<input type="button" value="+ '+plugin.name+'" onclick=\'addPlugin("'+plugin.name+'",0)\'/>';
	});
	
	$(".palette").html(html);
	
	// there may already be a chain, update rack.
	refreshRack();
	
});

// get the plugins json for all plugins into global
function getAllPlugins() {
	$.ajax({
		url: "racka3/getallplugins",
		cache: false,
		async: false
	}).done( function(json) {
		console.log(JSON.stringify(json));
		_allPlugins = json.plugins;
	});
}

function refreshRack() {
	$.ajax({
		url: "racka3/getpluginchain",
		cache: false,
		async: false
	}).done( function(json) {
		console.log("loaded "+json.plugins.length+" plugins for rack");
		
		$("#rack").empty();
		
		json.plugins.forEach(function(plugin) {

			var html = createHtmlPlugin(plugin);
			
			// insert at correct place in rack
			$("#rack").append(html);
			
			// knob render update
			$(".knob").knob({
				change : function (value) {
					var id=this.$.context.id.split("|");
					setParam(Number(id[0]),id[1],value);
				}
			});
			
			// update the sortables
    		$('.sortable').sortable({
				handle: '.pluginHandle'
			});
			$('.sortable').sortable().unbind();
			$('.sortable').sortable().bind('sortupdate', function(e,ui) { 				
   				var instance = ui.item[0].id;
   				var newPos = ui.item.parent().children('li').index(ui.item);
   				movePlugin(instance,newPos);
			});			
		});
	});
}

// creates a html knob from param object
function createHtmlKnob(instance,param) {
	
	var html = "";
	var knobId = instance+'|'+param.name;
	
	// knob or toggle, it always goes in a knob holder.
	html+='<div class="knobHolder">';
	
	// do we want a toggle button or a knob?
	if ( Math.abs(Number(param.max) - Number(param.min)) == Number(param.step) )
	{
		var checked = param.value==param.min ? '': 'checked="checked"' ;
		html+='<fieldset class="toggle">';
		html+='<input id="'+knobId+'" type="checkbox" '+checked+' ';
		html+='onclick="setParam('+instance+',\''+param.name+'\',this.checked?'+param.max+':'+param.min+')"';
		html+='/>';
		html+='<label for="'+knobId+'">';
		html+='<div class="toggle-button"><div class="toggle-tab"></div></div>';
		html+=param.name;
		html+='</label>';
		html+='</fieldset>';
	} else { 
		html+='<span class="paramName">'+param.name+'</span>';
		html+='<input class="knob" id="'+knobId+'" '; 
		html+='data-width="48" ';
		html+='data-height="48" ';
		html+='data-cursor="true" ';
		html+='data-thickness="0.3" ';
		html+='data-fgColor="#222222" ';
		html+='data-step="'+param.step+'" ';
		html+='data-angleOffset="-125" ';
		html+='data-angleArc="250" ';
		html+='data-min="'+param.min+'" ';
		html+='data-max="'+param.max+'" ';
		html+='value='+param.value+' ';
		html+='/>';
	}
	
	html+='</div>';
	
	return html;
	
}

// create a HTML representation of a plugin in our chain
function createHtmlPlugin(pluginObject) {
	
	if (pluginObject == null) {
		return null;
	}
	
	var position = pluginObject.position;
	var instance = pluginObject.instance;
	
	var html = "<li id='"+instance+"'><div class='pluginHolder'>";
	
	// 1. handle (left)
	html+="<div class='pluginHandle'>";
	html+='<div class="gripper">&nbsp;</div>';
	html+="</div>";
	
	if (pluginObject.name == "Mix Splitter" ||
		pluginObject.name == "Collector" ||
		pluginObject.name == "Channel B")
	{
		html+="<div class='plugin' style='background-color:#ffdede;' id='plugin"+pluginObject.instance+"'>";
	} else {
		html+="<div class='plugin' id='plugin"+pluginObject.instance+"'>";
	}
		
	html+="<span class='pluginName'>instance "+pluginObject.instance+", original pos "+pluginObject.position+"</span>";
	html+="<span class='pluginName'>"+pluginObject.name+"</span>";
	html+="<span class='pluginDescription'>"+pluginObject.description+"</span>";
	
	pluginObject.params.forEach(function(param) {
		html+=createHtmlKnob(pluginObject.instance,param);
	});
	
	html+='<br style="clear: left;"/>';
	html+="</div>";
	
	// 3. controls bar (right)
	html+="<div class='pluginBar'>";
	html+='<a class="icon" href="javascript:removePlugin('+instance+');">&#10799;</a></br/>';
	html+='<a class="icon" href="javascript:movePlugin('+instance+','+(position-1)+');">&#11014;</a><br/>';
	html+='<a class="icon" href="javascript:movePlugin('+instance+','+(position+1)+');">&#11015;</a><br/>';
	html+="</div>";
	
	
	html+="<br style='clear: left;'/></div></li>";
	
	return html;
}

function setParam(pluginInstance,paramName,paramValue) {
	
	var json = {"instance": pluginInstance, "param": paramName, "value": paramValue};
	
	$.ajax({
		type: "POST",
		url: "racka3/setparamvalue",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		if (json.error) {
			alert(json.error);
		} else {
			console.log("set "+pluginInstance+":"+paramName+" = "+paramValue);
		}
	});	
}

function movePlugin(pluginInstance,newPosition)
{
	console.log("moving plugin, instance "+pluginInstance+" new pos = "+newPosition);
	
	var json = {"instance": Number(pluginInstance), "position":Number(newPosition)};
	
	$.ajax({
		type: "POST",
		url: "racka3/moveplugin",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		if (json.error) {
			alert(json.error);
		} else {
			//console.log("removed "+pluginInstance);
			//$("#plugin"+pluginInstance).remove();
		}
	});	
	
	refreshRack();
}

function removePlugin(pluginInstance) {
	
	var json = {"instance": pluginInstance};
	
	$.ajax({
		type: "POST",
		url: "racka3/removeplugin",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		if (json.error) {
			alert(json.error);
		} else {
			//console.log("removed "+pluginInstance);
			//$("#plugin"+pluginInstance).remove();
			refreshRack();
		}
	});	
}

function addPlugin(pluginName,chainPosition) {
	
	var json = {"name": pluginName, "position": Number(chainPosition)};
	
	$.ajax({
		type: "POST",
		url: "racka3/addplugin",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		console.log(JSON.stringify(json));
		if (json.error) {
			alert(json.error);
		} else {			
			refreshRack();
		}
	});
}



</script>
<title>Racka3</title>
</head>

<body text="white">
<h1>Racka3</h1>

<div class="palette"></div>

<ul class="sortable" id="rack"></ul>

</body>
</html>