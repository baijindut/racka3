<html>
<head>
<style>
div.plugin
{
	outline-style:solid;
	background-color:#eeeeff;
	margin: 3px;
}

div.rack
{

}
span.pluginName
{
	display: block;
}
span.pluginDescription
{
	display: block;
}

div.knobHolder
{
	background-color:#ffffff;
	outline-style:solid;
	float: left;
	margin:2px;
}
span.paramName
{
	display:block;
}
</style>
<script src="jquery-1.10.2.min.js"></script>
<script src="jquery.knob.js"></script>
<script>
JSON.stringify = JSON.stringify || function (obj) {
    var t = typeof (obj);
    if (t != "object" || obj === null) {
        // simple data type
        if (t == "string") obj = '"'+obj+'"';
        return String(obj);
    }
    else {
        // recurse array or object
        var n, v, json = [], arr = (obj && obj.constructor == Array);
        for (n in obj) {
            v = obj[n]; t = typeof(v);
            if (t == "string") v = '"'+v+'"';
            else if (t == "object" && v !== null) v = JSON.stringify(v);
            json.push((arr ? "" : '"' + n + '":') + String(v));
        }
        return (arr ? "[" : "{") + String(json) + (arr ? "]" : "}");
    }
};

Array.prototype.insert = function (index, item) {
  this.splice(index, 0, item);
};
</script>
<script>

/*
 * Supported host functions are:
 * 
 * getAllPlugins
 *  	
 * addPlugin
 * swapPlugin
 * 
 * setPluginParams
 * getPluginParameters
 * 
 */

// holds JSON of all of the plugins
var _allPlugins;

// things to do at startup
$(document).ready(function() {
	
	getAllPlugins();
	console.log(_allPlugins.plugins.length + " plugins loaded.");
});

// get the plugins json for all plugins into global
function getAllPlugins() {
	$.ajax({
		url: "racka3/getallplugins",
		cache: false,
		async: false
	}).done( function(json) {
		console.log(JSON.stringify(json));
		_allPlugins = json;
	});
}

// creates a html knob from param object
function createHtmlKnob(instance,param) {
	
	var html="";
	
	html+='<div class="knobHolder">';
	html+='<span class="paramName">'+param.name+'</span>';
	html+='<input class="knob" id="'+instance+'|'+param.name+'" '; 
	html+='data-width="48" ';
	html+='data-height="48" ';
	html+='data-cursor="true" ';
	html+='data-thickness="0.3" ';
	html+='data-fgColor="#222222" ';
	html+='data-step="'+param.step+'" ';
	html+='data-angleOffset="-125" ';
	html+='data-angleArc="250" ';
	html+='data-min="'+param.min+'" ';
	html+='data-max="'+param.max+'" ';
	html+='value='+param.defaultValue+' ';
	html+='/></div>';
	
	return html;
	
}

// create a HTML representation of a plugin in our chain
function createHtmlPlugin(pluginObject) {
	
	if (pluginObject == null) {
		return null;
	}
	
	var html = "";

	html+="<div class='plugin' id='plugin"+pluginObject.instance+"'>";
	
	html+='<a href="javascript:removePlugin('+pluginObject.instance+');">[x]</a>';
	
	html+="<span class='pluginName'>instance "+pluginObject.instance+"</span>";
	html+="<span class='pluginName'>"+pluginObject.name+"</span>";
	html+="<span class='pluginDescription'>"+pluginObject.description+"</span>";
	
	pluginObject.params.forEach(function(param) {
		html+=createHtmlKnob(pluginObject.instance,param);
	});
	
	html+='<br style="clear: left;" />';
	html+="</div>";
	
	return html;
}

function setParam(pluginInstance,paramName,paramValue) {
	
	var json = {"instance": pluginInstance, "param": paramName, "value": paramValue};
	
	$.ajax({
		type: "POST",
		url: "racka3/setparamvalue",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		if (json.error) {
			alert(json.error);
		} else {
			console.log("set "+pluginInstance+":"+paramName+" = "+paramValue);
		}
	});	
}

function removePlugin(pluginInstance) {
	
	var json = {"instance": pluginInstance};
	
	$.ajax({
		type: "POST",
		url: "racka3/removeplugin",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		if (json.error) {
			alert(json.error);
		} else {
			console.log("removed "+pluginInstance);
			$("#plugin"+pluginInstance).remove();
		}
	});	
}

function addPlugin(pluginName,chainPosition) {
	
	var json = {"name": pluginName, "position": Number(chainPosition)};
	
	$.ajax({
		type: "POST",
		url: "racka3/addplugin",
		async: false,
		data: JSON.stringify(json)
	}).done( function(json) {
		console.log(JSON.stringify(json));
		if (json.error) {
			alert(json.error);
		} else {			
			// create the plugin html
			var html = createHtmlPlugin(json);
			
			// insert at correct place in rack
			$(".rack .plugin:eq("+json.position+")").before(html);
			
			// knob render update
			$(".knob").knob({
				change : function (value) {
					var id=this.$.context.id.split("|");
					setParam(Number(id[0]),id[1],value);
				}
			});	
			
		}
	});
}



</script>
<title>Racka3</title>
</head>

<body>
<h1>Racka3</h1>

<input type="button" value="getALlPlugins" onclick='getAllPlugins()'/>
<input type="button" value="addPlugin" onclick='addPlugin("Echoverse",0)'/>

<div class="rack" id="rack">
<div class="plugin" id="empty">&nbsp;</div>
</div>

</body>
</html>